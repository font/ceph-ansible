---
- name: debug osds
  debug:
    var: hostvars[inventory_hostname]

- name: set fact for osd pid container device
  set_fact:
    pid_container_namespace: '{{ ceph_osd_docker_devices[0] | basename }}'

- name: debug pid_container_namespace
  debug:
    var: pid_container_namespace

- name: set fact for osd device count
  set_fact:
    osd_device_count: '{{ ceph_osd_docker_devices | length }}'

- name: debug osd_device_count
  debug:
    var: osd_device_count

- name: generate systemd unit file
  become: true
  template:
    src: "{{ role_path }}/templates/ceph-osd.service.j2"
    dest: /etc/systemd/system/ceph-osd@.service
    owner: "root"
    group: "root"
    mode: "0644"
  failed_when: false

- fail:
    msg: "Erroring out early"

- name: check if a cluster is already running
  shell: "docker ps | grep -sq '{{ceph_osd_docker_username}}/{{ceph_osd_docker_imagename}}:{{ceph_osd_docker_image_tag}}'"
  register: ceph_health
  changed_when: false
  failed_when: false
  always_run: true

- include: checks.yml
  when:
    - ceph_health.rc != 0
    - not osd_containerized_deployment_with_kv
    - not "{{ rolling_update | default(false) }}"

- name: check if it is Atomic host
  stat: path=/run/ostree-booted
  register: stat_ostree
  always_run: true

- name: set fact for using Atomic host
  set_fact:
    is_atomic: '{{ stat_ostree.stat.exists }}'

- include: pre_requisite.yml
  when: not is_atomic

- include: "{{ playbook_dir }}/roles/ceph-common/tasks/misc/ntp_atomic.yml"
  when:
    - is_atomic
    - ansible_os_family == 'RedHat'
    - ntp_service_enabled

- include: "{{ playbook_dir }}/roles/ceph-common/tasks/misc/ntp_redhat.yml"
  when:
    - not is_atomic
    - ansible_os_family == 'RedHat'
    - ntp_service_enabled

- include: "{{ playbook_dir }}/roles/ceph-common/tasks/misc/ntp_debian.yml"
  when:
    - ansible_os_family == 'Debian'
    - ntp_service_enabled

- include: "{{ playbook_dir }}/roles/ceph-common/tasks/docker/fetch_image.yml"
  vars:
    ceph_docker_username: '{{ ceph_osd_docker_username }}'
    ceph_docker_imagename: '{{ ceph_osd_docker_imagename }}'
    ceph_docker_image_tag: '{{ ceph_osd_docker_image_tag }}'

# NOTE (jimcurtis): dirs_permissions.yml must precede fetch_configs.yml
# because it creates the directories needed by the latter.
- include: dirs_permissions.yml

- include: fetch_configs.yml
  when: not osd_containerized_deployment_with_kv

- include: selinux.yml
  when: ansible_os_family == 'RedHat'

- include: start_docker_osd.yml
