---
# This playbook purges a containerized Ceph cluster
# It removes: packages, configuration files and ALL THE DATA

- hosts:
  - mons
  - osds

  tasks:

      #  - name: install the latest version of gdisk
      #    yum:
      #      name: gdisk
      #      state: present

  # osds:
  - name: disable ceph osd service
  - name: kill ceph osd container
  - name: purge ceph osd disk
  - name: purge ceph osd disk again?
  - name: purge ceph directories

  # mons:
  - name: disable ceph mon service
  - name: kill ceph mon container
  - name: purge ceph directories

  # ansible host:
  - name: remove fetch directory


  - name: collect ceph containers
    shell: docker ps -aq --filter "ancestor={{ ceph_mon_docker_username }}/{{ ceph_mon_docker_imagename }}"
    register: containers

  - name: delete ceph containers
    shell: docker rm -f {{ item }}
    with_items: containers.stdout_lines

  - name: purge ceph directories
    file:
      path: "{{ item }}"
      state: absent
    with_items:
      - /etc/ceph/
      - /var/lib/ceph/

- hosts:
  - osds

  tasks:

  - name: disk zap
    command: sgdisk --zap-all --clear --mbrtogpt -g -- {{ item }}
    with_items: ceph_osd_docker_devices

  - name: disk zap again
    command: sgdisk --zap-all --clear --mbrtogpt -g -- {{ item }}
    with_items: ceph_osd_docker_devices
